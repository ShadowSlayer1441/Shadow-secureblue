#!/usr/bin/bash
    user=$SUDO_USER
    user_home=$(bash -c "cd ~$(printf %q "$user") && pwd")

    BASH_ENV_FILES=("$user_home/.bashrc" "$user_home/.bash_profile")
    if [ -f "$user_home/.bashrc/profile"]; then
        BASH_ENV_FILES+=("$user_home/.bashrc/profile")
    else 
        echo "No $user_home/.bashrc/profile file found."
    fi
    if [ -f "$user_home/.config/bash-completion"]; then
        BASH_ENV_FILES+=("$user_home/.config/bash-completion")
    else
        echo "No $user_home/.config/bash-completion file found"
    fi
    if [ -f "$user_home/.config/environment.d"]; then
        BASH_ENV_FILES+=("$user_home/.config/environment.d")
    else
        echo "No $user_home/.config/environment.d file found."
    fi

    echo "${b}WARNING${n} This will overwrite your .bashrc and .bash_profile."
    echo "This is needed to ensure the mitigation is effective."
    echo "Do you understand?"
    echo "Please type in \"YES I UNDERSTAND\" and press enter"
    read ACCEPT
    if [ "$ACCEPT" == "YES I UNDERSTAND" ]; then
      if lsattr "${BASH_ENV_FILES[0]}" 2>/dev/null | awk '{print $1}' | grep -q 'i'; then
        echo "Bash environment '(${BASH_ENV_FILES[@]})' is locked down. Unlocking it."
        for file in "${BASH_ENV_FILES[@]}"; do
            run0 chattr -i "$file"
        done
      else
        echo "Bash environment '(${BASH_ENV_FILES[@]})' is unlocked. Locking it."
        echo "
    # .bashrc

    # Source global definitions
    if [ -f /etc/bashrc ]; then
        . /etc/bashrc
    fi

    # User specific environment
    if ! [[ "\$PATH" =~ "\$user_home/.local/bin:\$user_home/bin:" ]]; then
        PATH="\$user_home/.local/bin:\$user_home/bin:\$PATH"
    fi
    export PATH

    # Uncomment the following line if you don't like systemctl's auto-paging feature:
    # export SYSTEMD_PAGER=

    unset rc
          " > ~/.bashrc

        echo "
    # .bash_profile

    # Get the aliases and functions
    if [ -f ~/.bashrc ]; then
        . ~/.bashrc
    fi

    # User specific environment and startup programs
        " > ~/.bash_profile

        for file in "${BASH_ENV_FILES[@]}"; do
            run0 chattr +i "$file"
        done
      fi
    else
      echo "Capitalization matters when you type \"YES I UNDERSTAND\""
    fi
